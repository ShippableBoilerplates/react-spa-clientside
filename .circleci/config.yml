version: 2
jobs:
    build:
        docker:
            - image: 'node:8.6.0'
        working_directory: ~/repo
        steps:
            - checkout
            - restore_cache:
                key: 'yarn-cache-{{ checksum "src/client/yarn.lock" }}'
            - run:
                name: install client dependencies 
                command: yarn install --no-progress
                working_directory: src/client
            - save_cache:
                key: 'yarn-cache-{{ checksum "src/client/yarn.lock" }}'
                paths:
                    - node_modules
            - run:
                name: get coveralls
                command: yarn global add coveralls
                working_directory: src/client
            - run: 
                name: lint, test and report coverage
                command: yarn test && cat ./coverage/lcov.info | coveralls
                working_directory: src/client
            - run:
                name: build client-side assets
                command: yarn build
            # todo: change back to root dir
            # todo: build and push to image registry